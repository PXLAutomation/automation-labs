#
# Vagrantfile to create PXL Labs (libvirt + AlmaLinux)
#

Vagrant.configure("2") do |config|

  # ----- Base Box (hard pinned) -----
  config.vm.box = "generic/alma9"
  config.vm.box_version = "4.3.12"

  MEMORY    = 2048
  CPUS      = 2
  DISK_SIZE = "40G"

  # Disable default /vagrant sync folder
  config.vm.synced_folder ".", "/vagrant", disabled: true

  # SSH config - reuse insecure key
  config.ssh.forward_agent = true
  config.ssh.insert_key = false
  config.ssh.private_key_path = "~/.vagrant.d/insecure_private_key"

  # --------------------------------
  # Libvirt Provider Configuration
  # --------------------------------
  config.vm.provider :libvirt do |lv|
    lv.memory = MEMORY
    lv.cpus   = CPUS
    lv.driver = "kvm"

    lv.storage :file,
      size: DISK_SIZE,
      type: "qcow2"
  end

  # --------------------------------
  # Common Hosts Block (Idempotent)
  # --------------------------------
  HOSTS_BLOCK = <<-SHELL
if ! grep -q "PXL_LAB_BEGIN" /etc/hosts; then
  cat <<EOF >> /etc/hosts

# PXL_LAB_BEGIN
10.10.0.10 webserver1.pxldemo.local webserver1
10.10.0.20 dbserver1.pxldemo.local dbserver1
# PXL_LAB_END

EOF
fi
  SHELL

  # -------------------------
  # Web Server
  # -------------------------
  config.vm.define "webserver1" do |server|
    server.vm.hostname = "webserver1.pxldemo.local"

    server.vm.network "forwarded_port",
      guest: 8080, host: 8080

    server.vm.network "private_network",
      ip: "10.10.0.10"

    server.vm.provision "shell", inline: HOSTS_BLOCK
  end

  # -------------------------
  # DB Server
  # -------------------------
  config.vm.define "dbserver1" do |server|
    server.vm.hostname = "dbserver1.pxldemo.local"

    server.vm.network "private_network",
      ip: "10.10.0.20"

    server.vm.provision "shell", inline: HOSTS_BLOCK
  end

  # --------------------------------
  # Update Host Machine /etc/hosts
  # --------------------------------
  config.trigger.after :up do |trigger|
    trigger.info = "Updating host /etc/hosts for PXL lab"
    trigger.run = { path: "update_hosts.sh" }
  end

  config.vm.post_up_message = "PXL Lab build complete."
end
